name: Generate Mihomo Rulesets

on:
  push:
    paths:
      - '**.yaml'
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Mihomo Tool
        run: |
          mkdir -p ./tools/
          # 下载 Mihomo 二进制工具 (使用 DustinWin 维护的版本)
          curl -L https://github.com/DustinWin/proxy-tools/releases/download/mihomo/mihomo-meta-linux-amd64v3.tar.gz | tar -zx -C ./tools/
          # 寻找解压后的二进制文件并统一命名
          find ./tools/ -type f -not -name "*.tar.gz" -exec mv {} ./tools/mihomo \;
          chmod +x ./tools/mihomo

      - name: Convert YAML to MRS
        run: |
          mkdir -p ./mrs/
          
          # 遍历所有 yaml 文件，排除隐藏目录和工具目录
          find . -maxdepth 2 -name "*.yaml" -not -path "./.*" -not -path "./tools/*" | while read -r file; do
            filename=$(basename "${file%.*}")
            
            # 排除非规则文件
            if [[ "$filename" =~ ^(config|README|example)$ ]]; then
              continue
            fi

            echo "---------------------------------------"
            echo "正在处理: $file"

            # 1. 自动检测规则类型 (Behavior Type)
            # 检测是否包含经典规则特征 (如 DOMAIN-SUFFIX, IP-CIDR 等)
            if grep -qE '^(  - )?(DOMAIN|IP-CIDR|GEOIP|IP-ASN|SRC-IP|DST-PORT)' "$file"; then
              TYPE="classical"
            # 检测是否包含 IP 地址特征 (x.x.x.x)
            elif grep -qE '([0-9]{1,3}\.){3}[0-9]{1,3}' "$file"; then
              TYPE="ipcidr"
            # 默认为域名类型
            else
              TYPE="domain"
            fi

            # 2. 预处理：确保文件包含 payload: 头部
            # 如果不包含，则创建一个带头部的临时文件
            if ! grep -q "payload:" "$file"; then
              echo "检测到缺少 payload 头部，正在自动补全..."
              echo "payload:" > "$file.tmp"
              # 确保原有内容以列表格式追加
              cat "$file" >> "$file.tmp"
              CONVERT_TARGET="$file.tmp"
            else
              CONVERT_TARGET="$file"
            fi

            # 3. 执行转换
            OUTPUT="./mrs/${filename}.mrs"
            echo "转换模式: [$TYPE] -> $OUTPUT"
            
            if ./
