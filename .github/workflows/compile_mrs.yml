- name: Convert YAML to MRS
        run: |
          mkdir -p ./mrs/
          find . -maxdepth 2 -name "*.yaml" -not -path "./.*" -not -path "./tools/*" | while read -r file; do
            filename=$(basename "${file%.*}")
            if [[ "$filename" =~ ^(config|README|example)$ ]]; then continue; fi

            echo "---------------------------------------"
            echo "正在处理: $file"

            # 1. 预清洗：删除空行，删除行首尾空格，确保 payload 格式正确
            # 先提取 payload 之后的内容并去除杂质，存入临时文件
            sed -n '/payload:/,$p' "$file" | grep -v "payload:" | sed 's/^[[:space:]]*- //g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^#' | grep . > rules_cleaned.tmp

            # 2. 判断该使用哪种模式
            # 检查是否包含逗号 (经典规则特征)
            if grep -q "," rules_cleaned.tmp; then
              TYPE="classical"
            # 检查是否包含 IP 特征
            elif grep -qE '([0-9]{1,3}\.){3}[0-9]{1,3}' rules_cleaned.tmp; then
              TYPE="ipcidr"
            else
              TYPE="domain"
            fi

            # 3. 构造标准的转换源文件
            echo "payload:" > ready_to_convert.yaml
            sed 's/^/  - /' rules_cleaned.tmp >> ready_to_convert.yaml

            # 4. 执行转换 (带错误捕获)
            OUTPUT="./mrs/${filename}.mrs"
            echo "尝试转换模式: [$TYPE]"
            
            if ! ./tools/mihomo convert-ruleset "$TYPE" yaml ready_to_convert.yaml "$OUTPUT" 2>err.log; then
              echo "警告: $TYPE 模式转换崩溃或失败，尝试降级为 domain 模式..."
              if ! ./tools/mihomo convert-ruleset "domain" yaml ready_to_convert.yaml "$OUTPUT" 2>>err.log; then
                echo "最终失败: $file"
                cat err.log
              else
                echo "降级转换成功 (domain)!"
              fi
            else
              SIZE=$(stat -c%s "$OUTPUT")
              echo "转换成功! 大小: $SIZE bytes"
            fi

            rm -f rules_cleaned.tmp ready_to_convert.yaml err.log
          done
