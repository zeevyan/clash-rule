name: Compile Clash MRS
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Mihomo via Pip
        run: |
          # 使用 mihomo 的 python 工具包，这专门用于处理规则转换
          pip install mihomo

      - name: Compile YAML to MRS
        run: |
          python -c "
          import os
          from mihomo.ruleset import Compiler
          
          compiler = Compiler()
          for file in os.listdir('.'):
              if file.endswith('.yaml'):
                  output = file.replace('.yaml', '.mrs')
                  print(f'Compiling {file} -> {output}')
                  try:
                      compiler.compile(file, output)
                      print(f'✅ Success')
                  except Exception as e:
                      print(f'❌ Failed: {e}')
          "

      - name: Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.mrs
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Auto-compile MRS via Python"
            git push
          fi
