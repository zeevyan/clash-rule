name: Convert YAML to MRS
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Zeevyan/clash-rule
        uses: actions/checkout@v4
        with:
          repository: zeevyan/clash-rule
          path: raw-rules

      - name: Setup Workspace
        run: |
          mkdir -p ./mihomo-ruleset/
          mkdir -p ./tools/

      - name: Download Mihomo Tool
        run: |
          # 下载 Mihomo 编译工具
          curl -L https://github.com/DustinWin/proxy-tools/releases/download/mihomo/mihomo-meta-linux-amd64v3.tar.gz | tar -zx -C ./tools/
          mv -f ./tools/CrashCore ./tools/mihomo
          chmod +x ./tools/mihomo

      - name: Convert YAML to MRS
        run: |
          # 进入原始规则目录寻找所有 yaml 文件
          cd raw-rules
          # 查找所有 .yaml 文件并循环处理
          # 排除可能会干扰的说明文件
          find . -maxdepth 1 -name "*.yaml" ! -name "config.yaml" | while read -r file; do
            filename=$(basename "$file" .yaml)
            echo "正在转换: $filename ..."
            ../tools/mihomo convert-ruleset domain yaml "$file" "../mihomo-ruleset/${filename}.mrs"
          done

      - name: Release and Upload
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: mihomo-ruleset
          tag: mihomo-ruleset
          overwrite: true
          body: |
            自动转换自 zeevyan/clash-rule 的 .mrs 规则集
            更新日期: ${{ env.update_version }}
          file_glob: true
          file: ./mihomo-ruleset/*.mrs

      - name: Push to Branch
        run: |
          cd ./mihomo-ruleset/
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b mrs-output
          git add .
          git commit -m "Update MRS files from zeevyan/clash-rule ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin mrs-output
