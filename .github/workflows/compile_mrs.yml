name: Build Mihomo MRS from Zeevyan
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *" # 每天北京时间凌晨 3 点运行
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Set Variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Zeevyan/clash-rule (Source)
        uses: actions/checkout@v4
        with:
          repository: zeevyan/clash-rule
          path: raw-rules

      - name: Setup Workspace
        run: |
          mkdir -p ./tools/
          mkdir -p ./mihomo-ruleset/

      - name: Download Mihomo Tool
        run: |
          # 下载 Mihomo 编译工具 (内核 Meta 版本)
          curl -L https://github.com/DustinWin/proxy-tools/releases/download/mihomo/mihomo-meta-linux-amd64v3.tar.gz | tar -zx -C ./tools/
          mv -f ./tools/CrashCore ./tools/mihomo
          chmod +x ./tools/mihomo

      - name: Convert YAML to MRS
        run: |
          # 进入原始规则目录
          cd raw-rules/
          
          # 查找当前目录下所有 yaml 文件并循环处理
          for file in *.yaml; do
            # 排除非规则文件
            [ "$file" == "config.yaml" ] && continue
            
            filename="${file%.*}"
            echo "正在转换规则: $file"

            # 智能检测：如果 YAML 包含 IP 段，则以 ipcidr 模式编译，否则以 domain 模式编译
            if grep -qiE "IP-CIDR|IP-CIDR6" "$file"; then
              type="ipcidr"
            else
              type="domain"
            fi

            # 执行转换命令
            ../tools/mihomo convert-ruleset "$type" yaml "$file" "../mihomo-ruleset/${filename}.mrs"
            
            # 将原始 yaml 文件也拷贝一份到产物目录
            cp "$file" "../mihomo-ruleset/"
          done

      - name: Release and Upload Assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: "Mihomo-Rules-${{ env.update_version }}"
          tag: mihomo-ruleset
          overwrite: true
          body: |
            ### 规则更新说明
            - **上游规则库**: [zeevyan/clash-rule](https://github.com/zeevyan/clash-rule)
            - **构建日期**: ${{ env.update_version }}
            - **文件说明**: `.mrs` 为 Mihomo 二进制格式，`.yaml` 为原始文本格式。
          file_glob: true
          file: ./mihomo-ruleset/*

      - name: Commit and Push to Branch
        run: |
          cd ./mihomo-ruleset/
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b mihomo-ruleset
          git add .
          git commit -m "Update Mihomo Rules from Zeevyan: ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin mihomo-ruleset

      - name: Purge jsDelivr CDN
        run: |
          cd ./mihomo-ruleset/
          for file in $(ls); do
            # 自动刷新 jsDelivr 缓存，确保通过 CDN 引用的规则实时更新
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@mihomo-ruleset/${file}"
          done
