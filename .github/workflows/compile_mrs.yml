name: Generate Mihomo Rulesets

on:
  push:
    paths:
      - '**.yaml'
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Mihomo Tool
        run: |
          mkdir -p ./tools/
          # 下载最新的 Mihomo Meta 核心
          curl -L https://github.com/DustinWin/proxy-tools/releases/download/mihomo/mihomo-meta-linux-amd64v3.tar.gz | tar -zx -C ./tools/
          find ./tools/ -type f -not -name "*.tar.gz" -exec mv {} ./tools/mihomo \;
          chmod +x ./tools/mihomo

      - name: Convert and Validate
        run: |
          mkdir -p ./mrs/
          
          find . -name "*.yaml" -not -path "./.*" -not -path "./tools/*" | while read -r file; do
            filename=$(basename "${file%.*}")
            if [[ "$filename" =~ ^(config|README|example)$ ]]; then continue; fi

            echo "---------------------------------------"
            echo "正在处理文件: $file"

            # 1. 自动检测类型：检测内容中是否包含 CIDR 或纯 IP 特征
            # 匹配模式：数字.数字.数字.数字/掩码 或 纯IP
            if grep -qE '([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]+)?' "$file"; then
              TYPE="ip"
            else
              TYPE="domain"
            fi

            # 2. 格式预检查：Mihomo 要求必须有 payload 字段
            if ! grep -q "payload:" "$file"; then
              echo "错误: $file 缺少 'payload:' 头部，Mihomo 无法转换！"
              echo "尝试临时补全 payload 头部进行转换..."
              sed -i '1i payload:' "$file"
            fi

            # 3. 执行转换
            OUTPUT="./mrs/${filename}.mrs"
            ./tools/mihomo convert-ruleset "$TYPE" yaml "$file" "$OUTPUT"

            # 4. 验证生成结果
            if [ -f "$OUTPUT" ]; then
              SIZE=$(stat -c%s "$OUTPUT")
              if [ "$SIZE" -le 100 ]; then
                echo "警告: 生成的 $OUTPUT 文件过小 ($SIZE bytes)，可能转换失败！"
              else
                echo "成功: [$TYPE] -> $OUTPUT ($SIZE bytes)"
              fi
            else
              echo "失败: 未能生成 $OUTPUT"
            fi
          done

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ./mrs/*.mrs
          if git diff --staged --quiet; then
            echo "无变化"
          else
            git commit -m "chore: auto-generate valid mrs rulesets"
            git push
          fi
