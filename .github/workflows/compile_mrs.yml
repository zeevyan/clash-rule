- name: Convert YAML to MRS
        run: |
          mkdir -p ./mrs/
          find . -maxdepth 2 -name "*.yaml" -not -path "./.*" -not -path "./tools/*" | while read -r file; do
            filename=$(basename "${file%.*}")
            if [[ "$filename" =~ ^(config|README|example)$ ]]; then continue; fi

            echo "---------------------------------------"
            echo "正在处理: $file"

            # 1. 自动检测规则类型 (修正优先级)
            if grep -qE 'DOMAIN|IP-CIDR|GEOIP|IP-ASN|SRC-IP|DST-PORT|PROCESS-NAME' "$file"; then
              TYPE="classical"
            elif grep -qE '([0-9]{1,3}\.){3}[0-9]{1,3}' "$file"; then
              TYPE="ipcidr"
            else
              TYPE="domain"
            fi

            # 2. 预处理 payload 头部
            if ! grep -q "payload:" "$file"; then
              echo "payload:" > "$file.tmp"
              cat "$file" >> "$file.tmp"
              CONVERT_TARGET="$file.tmp"
            else
              CONVERT_TARGET="$file"
            fi

            # 3. 执行转换
            OUTPUT="./mrs/${filename}.mrs"
            echo "转换模式: [$TYPE] -> $OUTPUT"
            
            if ./tools/mihomo convert-ruleset "$TYPE" yaml "$CONVERT_TARGET" "$OUTPUT"; then
              SIZE=$(stat -c%s "$OUTPUT")
              echo "转换成功! 大小: $SIZE bytes"
            else
              echo "转换失败: $file"
            fi
            [ -f "$file.tmp" ] && rm "$file.tmp"
          done
